<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MISE Store - Social Market</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #f44336; --header-bg: #1c1c1c; --bg-body: #f5f5f5; --text-dark: #222; --shiru-celeste: #00d4ff; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg-body); color: var(--text-dark); padding-bottom: 70px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* SHIRU (IA) */
        #shiru-float-btn { position: fixed; bottom: 100px; right: 20px; width: 55px; height: 55px; background: var(--shiru-celeste); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,212,255,0.4); z-index: 9999; cursor: grab; touch-action: none; }
        #shiru-float-btn i { color: white; font-size: 26px; }
        #shiru-window { position: fixed; bottom: 170px; right: 20px; width: 320px; height: 450px; background: #000; border: 2px solid var(--shiru-celeste); border-radius: 15px; display: none; flex-direction: column; overflow: hidden; z-index: 9998; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s ease; }
        #shiru-header { background: var(--shiru-celeste); color: #000; padding: 12px; font-weight: 900; display: flex; justify-content: space-between; align-items: center; }
        #shiru-body { flex: 1; padding: 15px; overflow-y: auto; color: #fff; background: #080808; scrollbar-width: none; }
        .s-msg { margin-bottom: 12px; max-width: 85%; padding: 10px; border-radius: 10px; font-size: 13px; line-height: 1.4; }
        .s-user { background: #333; color: #fff; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .s-bot { background: #1a1a1a; color: #eee; border: 1px solid #333; border-bottom-left-radius: 2px; }
        .s-card { background: #fff; color: #000; border-radius: 10px; overflow: hidden; margin-top: 10px; border: 2px solid var(--shiru-celeste); }
        .s-card img { width: 100%; height: 110px; object-fit: cover; }
        .s-card-info { padding: 8px; }
        .s-card-btn { width: 100%; background: #000; color: var(--shiru-celeste); border: none; padding: 8px; font-weight: bold; border-radius: 5px; cursor: pointer; font-size: 11px; }
        #shiru-footer { display: flex; padding: 10px; background: #111; gap: 8px; }
        #shiru-input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; outline: none; }
        #shiru-send { background: var(--shiru-celeste); border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* ESTILOS GENERALES */
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .main-header { background: var(--header-bg); padding: 10px 15px; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; z-index: 1000; }
        .search-box { flex: 1; background: white; border-radius: 20px; display: flex; align-items: center; padding: 6px 15px; height: 28px; }
        .search-box input { border: none; outline: none; width: 100%; margin-left: 8px; font-size: 14px; }
        .cart-icon-wrap { position: relative; cursor: pointer; }
        .cart-badge { position: absolute; top: -5px; right: -8px; background: var(--primary); color: white; font-size: 10px; padding: 2px 5px; border-radius: 10px; font-weight: bold; border: 1px solid var(--header-bg); }
        .cat-scroll { background: white; white-space: nowrap; overflow-x: auto; padding: 0; border-bottom: 1px solid #eee; position: sticky; top: 58px; z-index: 900; height: 45px; display: flex; align-items: center; }
        .cat-scroll::-webkit-scrollbar { display: none; }
        .cat-item { display: inline-block; padding: 0 20px; font-size: 14px; line-height: 43px; font-weight: 500; color: #666; transition: 0.2s; cursor: pointer; }
        .cat-item.active { color: var(--primary); font-weight: bold; border-bottom: 3px solid var(--primary); }
        .banner-area { padding: 0; background: #000; }
        .banner-area img { width: 100%; display: block; }
        .h-scroll-container { display: flex; overflow-x: auto; gap: 10px; padding: 10px; background: white; margin-bottom: 10px; scroll-behavior: smooth; }
        .h-scroll-container::-webkit-scrollbar { display: none; }
        .feat-card { min-width: 130px; max-width: 130px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; display: flex; flex-direction: column; border: 1px solid #f0f0f0; animation: fadeIn 0.5s; }
        .feat-img { width: 100%; height: 110px; object-fit: cover; }
        .feat-body { padding: 8px; flex: 1; display: flex; flex-direction: column; }
        .feat-title { font-size: 12px; height: 32px; overflow: hidden; margin-bottom: 5px; line-height: 1.3; }
        .feat-price { font-weight: 800; font-size: 16px; color: #333; margin-bottom: 3px; }
        .feat-tag { background: #ff5722; color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; width: fit-content; margin-bottom: 5px; }
        .feat-btn { background: var(--primary); color: white; border: none; width: 100%; padding: 5px; border-radius: 5px; font-size: 12px; margin-top: auto; cursor: pointer; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 8px; }
        .card { background: white; border-radius: 8px; overflow: hidden; padding-bottom: 10px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        .card img { width: 100%; height: 170px; object-fit: cover; background: #eee; }
        .card-body { padding: 8px; }
        .card-title { font-size: 13px; height: 36px; overflow: hidden; line-height: 1.3; margin-bottom: 5px; color:#333; }
        .price-row { display: flex; align-items: baseline; gap: 5px; }
        .price-main { color: var(--primary); font-weight: 800; font-size: 18px; }
        .price-old { font-size: 11px; text-decoration: line-through; color: #999; }
        .discount-tag { background: #fff0f0; color: var(--primary); font-size: 10px; padding: 2px 4px; border-radius: 3px; font-weight: bold; }
        
        /* DETALLE PRODUCTO */
        .detail-header { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #eee; }
        .slider-wrapper { position: relative; width: 100%; height: 380px; background: #fff; overflow: hidden; }
        .slider-track { display: flex; height: 100%; transition: transform 0.3s ease-out; }
        .slider-track img { min-width: 100%; height: 100%; object-fit: contain; }
        .slider-dots { position: absolute; bottom: 15px; width: 100%; display: flex; justify-content: center; gap: 8px; }
        .dot { width: 8px; height: 8px; background: rgba(0,0,0,0.2); border-radius: 50%; }
        .dot.active { background: var(--primary); }
        .detail-info { background: white; padding: 15px; margin-bottom: 80px; }
        .seller-badge { display: inline-flex; align-items: center; gap: 8px; background: #f0f0f0; padding: 5px 12px; border-radius: 20px; font-size: 12px; margin-top: 10px; cursor: pointer; font-weight: bold; color: #333; }
        .seller-badge img { width: 24px; height: 24px; border-radius: 50%; background: #ccc; }
        
        /* PERFIL VENDEDOR */
        .seller-profile-header { background: var(--header-bg); padding: 30px 20px; color: white; text-align: center; }
        .seller-avatar { width: 80px; height: 80px; background: #fff; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #333; }
        .seller-stats { display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 12px; }
        
        .detail-footer { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #ddd; display: flex; align-items: center; padding: 6px 10px; box-sizing: border-box; z-index: 2000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); gap: 10px; }
        .icon-action { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: #666; width: 45px; cursor: pointer; }
        .icon-action i { font-size: 18px; margin-bottom: 3px; color: #333; }
        .action-btns { flex: 1; display: flex; gap: 8px; }
        .btn-add-cart { flex: 1; background: #ffebd9; color: #ff5722; border: 1px solid #ff5722; border-radius: 20px; font-weight: bold; font-size: 13px; padding: 10px 0; cursor: pointer; }
        .btn-buy-now { flex: 1; background: var(--primary); color: white; border: none; border-radius: 20px; font-weight: bold; font-size: 13px; padding: 10px 0; cursor: pointer; }
        
        .sidebar { position: fixed; top: 0; left: -280px; width: 280px; height: 100%; background: white; z-index: 3000; transition: 0.3s; box-shadow: 2px 0 15px rgba(0,0,0,0.3); overflow-y: auto; }
        .sidebar-item { padding: 15px 20px; border-bottom: 1px solid #f5f5f5; display: flex; gap: 15px; align-items: center; color: #444; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; z-index: 2900; }
        .nav-bot { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 8px 0; border-top: 1px solid #eee; z-index: 900; }
        .nav-item { flex: 1; text-align: center; color: #999; font-size: 10px; }
        .nav-item i { font-size: 20px; margin-bottom: 3px; display: block; }
        .nav-item.active { color: var(--primary); }
        .view { display: none; }
        .view.active { display: block; }
        #toast { position: fixed; bottom: 90px; left: 50%; transform: translate(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 30px; display: none; z-index: 4000; font-size: 13px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { font-size: 11px; font-weight: bold; color: var(--primary); display: block; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="toast">Notificación</div>
<div class="overlay" onclick="toggleMenu()"></div>

<div id="shiru-float-btn">
    <i class="fa-solid fa-microchip"></i>
</div>

<div id="shiru-window">
    <div id="shiru-header">
        <span><i class="fa-solid fa-microchip"></i> SHIRU IA</span>
        <i class="fa-solid fa-xmark" onclick="toggleShiru()" style="cursor:pointer"></i>
    </div>
    <div id="shiru-body">
        <div class="s-msg s-bot">¡Hola! Soy Shiru. Puedes preguntarme por productos, envíos o nuestra garantía.</div>
    </div>
    <div id="shiru-footer">
        <input type="text" id="shiru-input" placeholder="Escribe tu consulta...">
        <button id="shiru-send"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<div class="sidebar" id="side">
    <div style="background:var(--header-bg); padding:30px 20px; color:white;">
        <h2 style="margin:0;">MISE</h2>
        <small>Social Shopping</small>
    </div>
    <div class="sidebar-item" onclick="nav('home')"><i class="fa-solid fa-house"></i> Inicio</div>
    <div class="sidebar-item" onclick="nav('profile')"><i class="fa-solid fa-user"></i> Mis Datos</div>
    <div class="sidebar-item" onclick="nav('favs')"><i class="fa-solid fa-heart"></i> Guardados</div>
    <div class="sidebar-item" onclick="nav('cart')"><i class="fa-solid fa-cart-shopping"></i> Mi Carrito</div>
    <div class="sidebar-item" onclick="nav('about')"><i class="fa-solid fa-circle-info"></i> Sobre Nosotros</div>
    <div class="sidebar-item" onclick="nav('privacy')"><i class="fa-solid fa-shield-halved"></i> Privacidad</div>
    <div class="sidebar-item" onclick="logout()" style="color:red; margin-top:20px; border-top:5px solid #f5f5f5;"><i class="fa-solid fa-power-off"></i> Cerrar Sesión</div>
</div>

<div id="v-home" class="view active">
    <div class="main-header">
        <i class="fa-solid fa-bars" style="color:white; font-size:20px;" onclick="toggleMenu()"></i>
        <div class="search-box">
            <i class="fa-solid fa-magnifying-glass" style="color:#999;"></i>
            <input type="text" id="srch" placeholder="Buscar en MISE..." oninput="filtrar()">
        </div>
        <div class="cart-icon-wrap" onclick="nav('cart')">
            <i class="fa-solid fa-cart-shopping" style="color:white; font-size:20px;"></i>
            <span class="cart-badge" id="cart-count">0</span>
        </div>
    </div>
    <div class="banner-area"><img src="https://i.ibb.co/Kj466DSG/1766078998421-2.jpg"></div>
    <div class="cat-scroll" id="cat-nav"></div>
    <div style="padding:15px 10px 5px; background:white;">
        <h3 style="margin:0; font-size:16px; display:flex; align-items:center; gap:5px; color:#ff5722;"><i class="fa-solid fa-fire"></i> Tendencias</h3>
    </div>
    <div class="h-scroll-container" id="featured-list"></div>
    <div class="grid" id="g-main"><p style="padding:20px; text-align:center;">Cargando catálogo...</p></div>
</div>

<div id="v-det" class="view">
    <div class="detail-header">
        <i class="fa-solid fa-arrow-left" onclick="nav('home')" style="font-size:20px; color:#333;"></i>
        <div style="font-weight:bold;">Detalle</div>
        <i class="fa-regular fa-heart" id="fav-icon" onclick="toggleFavDet()" style="font-size:20px; color:#333;"></i>
    </div>
    <div class="slider-wrapper" id="slider-area">
        <div class="slider-track" id="slider-track"></div>
        <div class="slider-dots" id="slider-dots"></div>
    </div>
    <div class="detail-info">
        <div class="price-row" style="margin-top:10px;"><span style="font-size:28px; font-weight:900; color:var(--primary);" id="dt-prc"></span></div>
        <h2 id="dt-tit" style="font-size:16px; margin:10px 0; font-weight:500; line-height:1.4;"></h2>
        
        <div id="seller-area" class="seller-badge" onclick="openSellerProfile()">
            <div class="seller-avatar" style="width:24px; height:24px; font-size:12px; margin:0;"><i class="fa-solid fa-user"></i></div>
            <span id="seller-name">Vendedor</span> <i class="fa-solid fa-chevron-right" style="font-size:10px; color:#999;"></i>
        </div>

        <div id="dt-desc" style="color:#666; font-size:13px; line-height:1.6; margin-top:15px;"></div>
        <div id="stk-val" style="font-size:12px; margin-top:10px; color:var(--primary);"></div>
    </div>
    <div class="detail-footer">
        <div class="icon-action" onclick="nav('home')"><i class="fa-solid fa-store"></i><span>Tienda</span></div>
        <div class="icon-action" onclick="toggleShiru()"><i class="fa-solid fa-comments"></i><span>Asistente</span></div>
        <div class="action-btns" id="action-btns-area"> 
            <button class="btn-add-cart" onclick="addToCart(false)">Agregar</button>
            <button class="btn-buy-now" onclick="addToCart(true)">Comprar</button>
        </div>
        <div id="no-stock-msg" style="display:none; flex:1; text-align:center; font-weight:bold; color:#999; font-size:12px;">Sin Stock</div>
    </div>
</div>

<div id="v-seller" class="view">
    <div class="detail-header">
        <i class="fa-solid fa-arrow-left" onclick="nav('home')" style="font-size:20px; color:#333;"></i>
        <div style="font-weight:bold;">Perfil Vendedor</div>
        <div></div>
    </div>
    <div class="seller-profile-header">
        <div class="seller-avatar"><i class="fa-solid fa-user"></i></div>
        <h2 id="p-seller-name" style="margin:0;">Usuario</h2>
        <div class="seller-stats">
            <div><b id="p-seller-count">0</b><br>Productos</div>
            <div><b>5.0</b><br>Calificación</div>
        </div>
    </div>
    <div style="padding:10px; background:white; font-weight:bold; border-bottom:1px solid #eee;">Publicaciones</div>
    <div class="grid" id="g-seller"></div>
</div>

<div id="v-profile" class="view" style="padding:20px;">
    <h3>Datos de Envío (El Salvador)</h3>
    <div style="background:white; padding:20px; border-radius:10px; border:1px solid #ddd;">
        <div class="form-group"><label>Nombre Completo</label><input type="text" id="f-n"></div>
        <div class="form-group"><label>WhatsApp</label><input type="tel" id="f-p"></div>
        <div class="form-group"><label>Departamento</label>
            <select id="f-d">
                <option value="">Seleccione...</option><option>San Salvador</option><option>Santa Ana</option><option>San Miguel</option><option>La Libertad</option><option>Sonsonate</option><option>Ahuachapán</option><option>La Paz</option><option>Cuscatlán</option><option>Usulután</option><option>San Vicente</option><option>La Unión</option><option>Morazán</option><option>Cabañas</option><option>Chalatenango</option>
            </select>
        </div>
        <div class="form-group"><label>Municipio / Ciudad</label><input type="text" id="f-c"></div>
        <div class="form-group"><label>Colonia / Barrio</label><input type="text" id="f-col"></div>
        <div class="form-group"><label>Dirección Exacta</label><input type="text" id="f-dir"></div>
        <div class="form-group"><label>Color de Casa</label><input type="text" id="f-clr"></div>
        <div class="form-group"><label>Referencia</label><input type="text" id="f-ref"></div>
        <button onclick="saveProf()" style="width:100%; background:var(--header-bg); color:white; padding:15px; border:none; border-radius:8px; font-weight:bold;">Guardar Información</button>
    </div>
</div>

<div id="v-cart" class="view" style="padding:20px;"><h3>Mi Carrito</h3><div id="cart-list"></div><div id="cart-total" style="text-align:right; font-size:20px; font-weight:bold; margin:20px 0;"></div><div id="paypal-area"></div></div>
<div id="v-favs" class="view" style="padding:20px;"><h3>Favoritos</h3><div class="grid" id="g-favs"></div></div>
<div id="v-about" class="view" style="padding:20px;"><h3>Sobre Nosotros</h3><p>MISE es el marketplace líder de El Salvador, un proyecto de XXII Atelier Design creado por Juan Steven López Ramírez. Nuestra misión es conectar compradores y vendedores locales con total seguridad.</p></div>
<div id="v-privacy" class="view" style="padding:20px;"><h3>Privacidad</h3><p>En MISE tu seguridad es prioridad. Retenemos el pago hasta que recibas tu pedido conforme. Ofrecemos reembolsos garantizados y revisión humana de cada tienda.</p></div>

<div class="nav-bot" id="nav-bot">
    <div class="nav-item active" onclick="nav('home')"><i class="fa-solid fa-house"></i>Inicio</div>
    <div class="nav-item" onclick="nav('favs')"><i class="fa-solid fa-heart"></i>Guardados</div>
    <div class="nav-item" onclick="nav('profile')"><i class="fa-solid fa-user"></i>Perfil</div>
    <div class="nav-item" onclick="nav('cart')"><i class="fa-solid fa-cart-shopping"></i>Carrito</div>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbx9njkAHEn2J6cJYP2RR7K6hHDE7vPxVlTF-2c-BXhk0LwHzouxtIbHo21LbhVZIAxN/exec";
    const GPT_API_KEY = 'sk-proj-1B6UKfS3yeJUEoG2m3q'; 
    
    let DB = [], cart = [], favs = [], sel = null, currentSlide = 0, shiruHistory = [];

    async function init() {
        try {
            const r = await fetch(API + "?t=" + Date.now());
            if (!r.ok) throw new Error("Error red");
            const raw = await r.json();
            
            let rawList = [];
            if(Array.isArray(raw)) rawList = raw;
            else if(raw && raw.data) rawList = raw.data;
            
            DB = rawList.map(item => {
                return {
                    id: item.id || item.ID,
                    title: item.title || item.nombre || item.NOMBRE || "Sin Nombre",
                    price: Number(item.price || item.precio || item.PRECIO || 0),
                    image: item.image || item.imagen || item.IMAGEN || "",
                    desc: item.description || item.descrip || item.DESCRIP || "",
                    cat: item.category || item.categoria || item.CATEGORIA || "General",
                    stock: item.stock || item.STOCK || 0,
                    user: item.usuario || item.USUARIO || "MiseOficial"
                };
            });

            favs = JSON.parse(localStorage.getItem('m_favs')) || [];
            loadProf(); renderCategories(); personalizeFeed(); initShiruDraggable();
        } catch(e) { document.getElementById('g-main').innerHTML = "Error cargando."; console.error(e); }
    }

    // --- SHIRU INTELIGENTE (PRODUCTOS + POLÍTICAS) ---
    document.getElementById('shiru-send').onclick = async () => {
        const input = document.getElementById('shiru-input');
        const text = input.value.trim();
        if(!text) return;
        const body = document.getElementById('shiru-body');
        body.innerHTML += `<div class="s-msg s-user">${text}</div>`;
        input.value = ''; body.scrollTop = body.scrollHeight;

        try {
            if(!GPT_API_KEY || GPT_API_KEY.includes("PEGAR")) {
                body.innerHTML += `<div class="s-msg s-bot">⚠️ Falta API Key.</div>`; return;
            }

            const keywords = text.toLowerCase().split(" ");
            const matches = DB.filter(p => keywords.some(k => p.title.toLowerCase().includes(k) || p.cat.toLowerCase().includes(k)));
            const contextList = matches.slice(0, 10).map(p => `- ${p.title} ($${p.price}, ID: ${p.id})`).join("\n");
            
            const privacyText = document.getElementById('v-privacy').innerText;
            const aboutText = document.getElementById('v-about').innerText;

            let systemPrompt = `Eres Shiru, asistente de MISE. 
            INFORMACIÓN DE LA TIENDA: ${aboutText}. 
            POLÍTICAS DE SEGURIDAD: ${privacyText}.
            
            EL USUARIO BUSCA: "${text}".
            
            PRODUCTOS ENCONTRADOS EN DB: 
            ${contextList}
            
            REGLAS:
            1. Si pregunta por productos, recomienda de la lista y pon (ID: id_num) al final.
            2. Si pregunta por seguridad, envíos o privacidad, responde usando la Información de la Tienda.
            3. Sé breve.`;

            shiruHistory.push({ role: 'system', content: systemPrompt });
            shiruHistory.push({ role: 'user', content: text });

            const res = await axios.post('https://api.openai.com/v1/chat/completions', { model: 'gpt-4o-mini', messages: shiruHistory }, { headers: { 'Authorization': `Bearer ${GPT_API_KEY}` } });
            const reply = res.data.choices[0].message.content;
            
            body.innerHTML += `<div class="s-msg s-bot">${reply.replace(/\(ID: \d+\)/g, '')}</div>`;

            const idMatches = reply.match(/\(ID: (\d+)\)/g);
            if (idMatches) {
                idMatches.forEach(m => {
                    const id = m.replace(/\D/g, '');
                    const p = DB.find(x => x.id == id);
                    if (p) body.innerHTML += `<div class="s-card"><img src="${p.image}"><div class="s-card-info"><b>${p.title}</b><br><span>$${p.price}</span><br><button class="s-card-btn" onclick="openD(${p.id}); toggleShiru();">VER</button></div></div>`;
                });
            }
        } catch (e) { body.innerHTML += `<div class="s-msg s-bot">Error de conexión.</div>`; }
        body.scrollTop = body.scrollHeight;
    };

    function openD(id) {
        sel = DB.find(x => x.id == id); if(!sel) return;
        document.getElementById('dt-tit').innerText = sel.title;
        document.getElementById('dt-prc').innerText = "$" + sel.price.toFixed(2);
        document.getElementById('dt-desc').innerText = sel.desc;
        document.getElementById('stk-val').innerText = sel.stock > 0 ? `Stock: ${sel.stock}` : "Agotado";
        document.getElementById('seller-name').innerText = sel.user; 
        const track = document.getElementById('slider-track'); 
        track.innerHTML = `<img src="${sel.image}">`;
        updateBtnState(sel.stock); nav('det'); updateFavIcon(); 
    }

    function openSellerProfile() {
        if(!sel) return;
        const sellerUser = sel.user;
        const sellerProds = DB.filter(p => p.user === sellerUser);
        document.getElementById('p-seller-name').innerText = sellerUser;
        document.getElementById('p-seller-count').innerText = sellerProds.length;
        const grid = document.getElementById('g-seller');
        if(sellerProds.length > 0) {
            grid.innerHTML = sellerProds.map(p => `<div class="card" onclick="openD(${p.id})"><img src="${p.image}"><div class="card-body"><div class="card-title">${p.title}</div><b>$${p.price}</b></div></div>`).join('');
        } else {
            grid.innerHTML = "<p style='padding:20px; text-align:center;'>Este usuario no tiene más productos.</p>";
        }
        nav('seller');
    }

    function personalizeFeed() {
        if(!DB.length) return;
        renderFeatured(DB.slice(0,6));
        renderHome(DB);
    }

    function renderFeatured(d) { document.getElementById('featured-list').innerHTML = d.map(p => `<div class="feat-card" onclick="openD(${p.id})"><img src="${p.image}" class="feat-img"><div class="feat-body"><div class="feat-title">${p.title}</div><div class="feat-price">$${p.price}</div><button class="feat-btn">VER</button></div></div>`).join(''); }
    function renderHome(d) { document.getElementById('g-main').innerHTML = d.map(p => `<div class="card" onclick="openD(${p.id})"><img src="${p.image}" loading="lazy"><div class="card-body"><div class="card-title">${p.title}</div><div class="price-row"><span class="price-main">$${p.price}</span></div></div></div>`).join(''); }
    function renderCategories() { const uc = ['Todos', ...new Set(DB.map(x => x.cat).filter(Boolean))]; document.getElementById('cat-nav').innerHTML = uc.map(c => `<div class="cat-item ${c==='Todos'?'active':''}" onclick="filterCat('${c}', this)">${c}</div>`).join(''); }
    function filterCat(c, el) { document.querySelectorAll('.cat-item').forEach(x => x.classList.remove('active')); el.classList.add('active'); renderHome(c==='Todos'?DB:DB.filter(x => x.cat === c)); }
    
    function initShiruDraggable() {
        const btn = document.getElementById('shiru-float-btn'); let active = false, iX, iY, xO=0, yO=0;
        btn.addEventListener("touchstart", e=>{ iX=e.touches[0].clientX-xO; iY=e.touches[0].clientY-yO; active=true; });
        window.addEventListener("touchend", ()=>active=false);
        window.addEventListener("touchmove", e=>{ if(active){ e.preventDefault(); xO=e.touches[0].clientX-iX; yO=e.touches[0].clientY-iY; btn.style.transform=`translate3d(${xO}px, ${yO}px, 0)`; }});
        btn.onclick=()=>{if(!active)toggleShiru()};
    }
    function toggleShiru(){ const w=document.getElementById('shiru-window'); w.style.display=(w.style.display==='flex')?'none':'flex'; }
    
    // --- LÓGICA DE AGREGAR AL CARRITO (CORREGIDA CON LIMITE DE STOCK) ---
    function countInCart(id) {
        return cart.filter(item => item.id === id).length;
    }

    function addToCart(bn) {
        if(!sel) return;
        
        // 1. Verificamos cuántos hay en el carrito
        const currentQty = countInCart(sel.id);
        
        // 2. Si ya tienes el máximo disponible, BLOQUEAMOS
        if (currentQty >= sel.stock) {
            showToast("❌ Límite de stock alcanzado");
            return;
        }

        // 3. Si hay espacio, agregamos
        cart.push(sel);
        updateCartBadge();
        
        if(bn) nav('cart'); 
        else showToast("✅ Agregado"); 
    }

    function updateCartBadge() { document.getElementById('cart-count').innerText = cart.length; }
    function updateBtnState(s) { const b=document.getElementById('action-btns-area'); const m=document.getElementById('no-stock-msg'); if(s<=0){b.style.display='none';m.style.display='block'}else{b.style.display='flex';m.style.display='none'} }
    
    function nav(v) { document.querySelectorAll('.view').forEach(x => x.classList.remove('active')); document.getElementById('v-'+v).classList.add('active'); window.scrollTo(0,0); if(v==='cart') renderCart(); if(v==='favs') renderFavs(); }
    
    function renderCart() { 
        const cl = document.getElementById('cart-list'); 
        if(!cart.length) { cl.innerHTML="<p>Vacío</p>"; document.getElementById('paypal-area').innerHTML=""; return; }
        
        cl.innerHTML = cart.map((i,idx) => `<div style="display:flex; padding:10px; border-bottom:1px solid #eee;"><img src="${i.image}" style="width:40px;"> <div style="flex:1; margin-left:10px;">${i.title}</div><b>$${i.price}</b> <i class="fa-solid fa-trash" onclick="cart.splice(${idx},1); renderCart(); updateCartBadge();" style="color:red; margin-left:10px;"></i></div>`).join('');
        
        const tot = cart.reduce((a,b)=>a+b.price,0).toFixed(2);
        document.getElementById('cart-total').innerText="Total: $"+tot; 
        
        const pa = document.getElementById('paypal-area');
        pa.innerHTML="";

        if(parseFloat(tot) < 20.00) {
            pa.innerHTML = `<div style="text-align:center; color:white; background:#ff5252; padding:15px; border-radius:10px; font-weight:bold; margin-top:20px;">
                <i class="fa-solid fa-circle-exclamation"></i> El pedido mínimo es de $20.00<br>
                <small style="font-weight:normal;">Te faltan $${(20 - parseFloat(tot)).toFixed(2)}</small>
            </div>`;
        } else {
            paypal.Buttons({ createOrder: (d,a) => a.order.create({ purchase_units: [{ amount: { value: tot } }] }), onApprove: () => { cart=[]; nav('home'); alert("Pago OK"); } }).render('#paypal-area');
        }
    }
    
    function toggleFavDet() { 
        const idx = favs.findIndex(x => x.id === sel.id);
        if(idx > -1) { favs.splice(idx,1); showToast("Eliminado de favoritos"); }
        else { favs.push(sel); showToast("¡Agregado a favoritos!"); }
        localStorage.setItem('m_favs', JSON.stringify(favs));
        updateFavIcon();
    }
    function updateFavIcon() { 
        const i = document.getElementById('fav-icon'); 
        const isF = favs.some(x => x.id === sel.id); 
        i.className = isF ? "fa-solid fa-heart" : "fa-regular fa-heart"; 
        i.style.color = isF ? "var(--primary)" : "#333"; 
    }
    function renderFavs() { 
        const g = document.getElementById('g-favs');
        if(!favs.length) { g.innerHTML = "<p>No tienes favoritos.</p>"; return; }
        g.innerHTML = favs.map(p=>`<div class="card" onclick="openD(${p.id})"><img src="${p.image}" style="height:120px; object-fit:cover;"><div class="card-body"><b>${p.title}</b></div></div>`).join(''); 
    }

    function saveProf() { 
        const p = { 
            n:document.getElementById('f-n').value, p:document.getElementById('f-p').value, 
            d:document.getElementById('f-d').value, c:document.getElementById('f-c').value, 
            col:document.getElementById('f-col').value, dir:document.getElementById('f-dir').value, 
            clr:document.getElementById('f-clr').value, ref:document.getElementById('f-ref').value 
        }; 
        localStorage.setItem('m_prof', JSON.stringify(p)); showToast("Datos guardados"); 
    }
    function loadProf() { 
        const p = JSON.parse(localStorage.getItem('m_prof')); 
        if(p) { 
            document.getElementById('f-n').value=p.n; document.getElementById('f-p').value=p.p; 
            document.getElementById('f-d').value=p.d; document.getElementById('f-c').value=p.c; 
            document.getElementById('f-col').value=p.col; document.getElementById('f-dir').value=p.dir; 
            document.getElementById('f-clr').value=p.clr; document.getElementById('f-ref').value=p.ref; 
        } 
    }

    function toggleMenu() { const s=document.getElementById('side'); const o=s.style.left==='0px'; s.style.left=o?'-280px':'0px'; document.querySelector('.overlay').style.display=o?'none':'block'; }
    function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
    function logout() { localStorage.clear(); location.reload(); }
    function filtrar() { const v=document.getElementById('srch').value.toLowerCase(); renderHome(DB.filter(p=>p.title.toLowerCase().includes(v))); }
    
    init();
</script>
</body>
</html>
